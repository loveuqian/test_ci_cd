ENV["FASTLANE_PASSWORD"] = "1HateInstagram1HateInstagram"
ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = "cuzx-bmjq-xgqr-tkcb"
ENV["MATCH_KEYCHAIN_PASSWORD"] = "123456"
ENV["APP_IDENTIFIER"] = "com.taglife.taglife2"
ENV["TEAM_ID"] = "H26DA27U2W"
ENV["TEAM_NAME"] = "Alex Petrov"
ENV["FASTLANE_USER"] = "taglife@yandex.ru"
ENV["FASTLANE_SESSION"] = '---\n- !ruby/object:HTTP::Cookie\n  name: DES5c9a8beaa1594b32990e69d5b66458cc1\n  value: HSARMTKNSRVXWFlaT0LcZnz6RtnyWUPsFubG79NPnPmWK47tsMhY0LQ3ZbY8eTUhvdThtBkGBxqjow2zc+EYepkeSDdYTD2qetdQahf7XE+3WhrP1prwcuLeCyEZQWebl01F7kZjo2amdPk4PG8TSRVX\n  domain: idmsa.apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 2592000\n  created_at: 2020-09-26 12:15:30.166061000 +02:00\n  accessed_at: 2020-09-27 19:06:31.577702000 +02:00\n- !ruby/object:HTTP::Cookie\n  name: myacinfo\n  value: DAWTKNV244b7406f7439ec67e6bd04e11fe0e1c68adb854f5bc5becf37559242aee476c3590f45e861c95765c9baef5ab377bc4c49aaa6f1dc50bfb5b4abebb7111991e3a65463d20f0618ec24da89afd97eeb11981edae8174ef23b5cdd71b44f8d1e4d6e72dea23916262296e914d7aabfae787a374f9153e844eb07a8d74a0dcfa3db02e450cf37458edba1c443a99e76b1a7e28e828195ef028429477990e27ce57eb4a44c0c37e55cf4581a239c3e95defaf8e7a459961e56216aa800e452d6d915036a650ed6136294a35395444357b61145e43d3c2f3ca4948b0df5e4c42c244556d5004d85cd1a89347f4e04275ff9f5d3d01bb1253ae0806e4120b24276155830613366313062636631303439396365316230326433343564623130313938613934626631653539MVRYV2\n  domain: apple.com\n  for_domain: true\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age:\n  created_at: 2020-09-27 19:06:32.350100000 +02:00\n  accessed_at: 2020-09-27 20:58:35.317392000 +02:00\n- !ruby/object:HTTP::Cookie\n  name: dqsid\n  value: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDEyMzMxMTUsImp0aSI6IjlTc25tVlFVcHRVYjhrbVVNSG5lY0EifQ.cKxMbpfBcnTqHbp7h9f0yHO7DB1Hpsy9vvM91lllOtU\n  domain: appstoreconnect.apple.com\n  for_domain: false\n  path: "/"\n  secure: true\n  httponly: true\n  expires:\n  max_age: 1800\n  created_at: &1 2020-09-27 20:58:36.470172000 +02:00\n  accessed_at: *1\n'
ENV["MATCH_PASSWORD"] = "123456"

update_fastlane

default_platform(:ios)

platform :ios do
  desc "Description of what the lane does"
  lane :inc do
    current_branch = git_branch
    get_build_number 
    increment_build_number(xcodeproj: "Qooore.xcodeproj")
    increment_version_number()

    commit_version_bump(
      message: "Bumped version of app to #{get_version_number}",
      force: true
    )

    add_git_tag(
      tag: "test-#{get_version_number}_alpha"
    )

    push_to_git_remote(
      remote: "https://github.com/dvereshchagin/test_ci_cd.git",
      local_branch: current_branch,
      remote_branch: current_branch,
      force: true,
      tags: true
    )
  end

  desc "Increment beta version"
  lane :inc_beta do
    current_branch = git_branch
    get_build_number 
    increment_build_number(xcodeproj: "Qooore.xcodeproj")
    increment_version_number()

    commit_version_bump(
      message: "Bumped version of app to #{get_version_number}",
      force: true
    )

    add_git_tag(
      tag: "#{get_version_number}_beta"
    )

    push_to_git_remote(
      remote: "https://github.com/dvereshchagin/test_ci_cd.git",
      local_branch: current_branch,
      remote_branch: current_branch,
      force: true,
      tags: true,
    )
  end


  desc "Increment release version"
  lane :inc_release do
    current_branch = git_branch
    get_build_number 
    increment_build_number(xcodeproj: "Qooore.xcodeproj")
    increment_version_number()

    commit_version_bump(
      message: "Bumped version of app to #{get_version_number}",
      force: true
    )

    push_to_git_remote(
      remote: "https://github.com/dvereshchagin/test_ci_cd.git",
      local_branch: current_branch,
      remote_branch: current_branch,
      force: true,
      tags: true,
    )
  end

  desc "Get certificates"
  lane :get_certificates_or_generate do

    create_keychain(
    name: "KeychainName",
    password: "123456",
    default_keychain: true,
    unlock: true,
    timeout: 3600,
    lock_when_sleeps: true
    )

    match(
      type: "appstore",
      readonly: true,
      app_identifier: ENV["APP_IDENTIFIER"],
      username: ENV["FASTLANE_USER"],
      team_id: ENV["TEAM_ID"],
      team_name: ENV["TEAM_NAME"],
      verbose: true,
      keychain_name: "KeychainName",
      keychain_password: "123456"
    );
  end

  desc "Build App"
  lane :buildling_app do
      build_app(
      scheme: "Qooore",
      workspace: "Qooore.xcworkspace",
      clean: true,
      output_directory: "./assembles/test-#{get_version_number}_alpha",
      output_name: "test-#{get_version_number}_alpha",
      silent: false
    );

    zip(
      path: "./assembles/test-#{get_version_number}_alpha/test-#{get_version_number}_alpha.ipa",
      output_path: "./assembles/test-#{get_version_number}_alpha.zip",
      verbose: true
    );

  end

  desc "Build Release App"
  lane :buildling_app_release do
      build_app(
      scheme: "Qooore",
      workspace: "Qooore.xcworkspace",
      clean: true,
      output_name: "#{get_version_number}",
      silent: false
    );
  end

  desc "Build App Beta"
  lane :buildling_app_beta do
      build_app(
      scheme: "Qooore",
      workspace: "Qooore.xcworkspace",
      clean: true,
      output_directory: "./assembles/#{get_version_number}_beta",
      output_name: "#{get_version_number}_beta",
      silent: false
    );

    zip(
      path: "./assembles/#{get_version_number}_beta/#{get_version_number}_beta.ipa",
      output_path: "./assembles/#{get_version_number}_beta.zip",
      verbose: true
    );

  end

  desc "Deploy App to TestFlight"
  lane :deploy do
    upload_to_testflight(
      username: ENV["FASTLANE_USER"],
      app_identifier: ENV["APP_IDENTIFIER"],
      ipa: "./assembles/test-#{get_version_number}/test-#{get_version_number}_alpha.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    );

    sh('sh ../.github/scripts/clean_all.sh')

  end

  desc "Deploy App to TestFlight"
  lane :deploy_beta do
    upload_to_testflight(
      username: ENV["FASTLANE_USER"],
      app_identifier: ENV["APP_IDENTIFIER"],
      ipa: "./assembles/#{get_version_number}_beta/#{get_version_number}_beta.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      verbose: true,
    );

    sh('sh ../.github/scripts/clean_all.sh')

  end

  desc "Deploy release app to TestFlight"
  lane :deploy_release do
    upload_to_testflight(
      username: ENV["FASTLANE_USER"],
      app_identifier: ENV["APP_IDENTIFIER"],
      apple_id: 1533519777,
      ipa: "../assembles/#{get_version_number}/#{get_version_number}.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true
    );

    sh('sh ../.github/scripts/clean_all.sh')

  end

end
